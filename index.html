<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQMessage Ultra Max</title>
    <style>
        :root { --primary: #0084ff; --success: #28a745; --danger: #dc3545; --dark: #232d36; --light: #f0f2f5; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--light); height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout */
        .app-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 300px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; transition: 0.3s; }
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; z-index: 10; height: 100%; left: 0; display: none; }
            .sidebar.active { display: flex; }
        }

        /* UI Elements */
        .header { padding: 15px; background: var(--dark); color: white; display: flex; justify-content: space-between; align-items: center; }
        .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px; border-radius: 12px; max-width: 80%; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { align-self: flex-end; background: #dcf8c6; }
        .received { align-self: flex-start; background: white; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        /* Inputs */
        .input-area { padding: 10px; background: #f0f0f0; display: flex; gap: 8px; align-items: center; }
        .input-area input { flex: 1; padding: 12px; border-radius: 25px; border: none; outline: none; }
        .circle-btn { width: 45px; height: 45px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
        
        /* Call Overlay */
        #callOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; color:white; z-index:9999; }
        .recording-active { background: var(--danger) !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="callOverlay">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ‘¤</div>
        <h2 id="callInfo">Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø©...</h2>
        <audio id="remoteAudio" autoplay></audio>
        <div style="display: flex; gap: 20px;">
            <button id="acceptCall" class="circle-btn" style="background:var(--success); display:none;">ğŸ“</button>
            <button onclick="rejectOrEndCall()" class="circle-btn" style="background:var(--danger);">ğŸ“µ</button>
        </div>
    </div>

    <div class="header">
        <span>IQMessage Pro</span>
        <small id="myHandle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</small>
        <button onclick="toggleSidebar()" id="menuBtn" style="display:none;">â˜°</button>
    </div>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div style="padding: 15px;">
                <input type="text" id="targetUser" placeholder="Ø£Ø¶Ù @user..." style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;">
                <button onclick="addFriend()" style="width:100%; margin-top:10px; padding:10px; background:var(--primary); color:white; border:none; border-radius:8px;">Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</button>
            </div>
            <div id="contactsList" style="flex:1; overflow-y:auto;"></div>
        </div>

        <div class="main-chat">
            <div id="chatHeader" style="padding:10px; background:#eee; display:flex; justify-content:space-between;">
                <b id="activeFriendTitle">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©</b>
                <button id="callBtn" onclick="startCall()" style="display:none; border:none; background:none; font-size:20px; cursor:pointer;">ğŸ“</button>
            </div>
            <div class="messages" id="messageBox"></div>
            <div class="input-area">
                <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="sendImage(this)">
                <button class="circle-btn" style="background:#666;" onclick="document.getElementById('fileInput').click()">ğŸ“·</button>
                <input type="text" id="msgText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                <button id="micBtn" class="circle-btn" style="background:var(--danger);" onmousedown="recordStart()" onmouseup="recordStop()">ğŸ¤</button>
                <button class="circle-btn" style="background:var(--primary);" onclick="sendTextMsg()">â¤</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3wLBeOqmW1LZBLR2icOwDdbUBD8EstYQ",
  authDomain: "iqmassege.firebaseapp.com",
  projectId: "iqmassege",
  storageBucket: "iqmassege.firebasestorage.app",
  messagingSenderId: "430582759156",
  appId: "1:430582759156:web:b0fcd429433607e16ae8a1",
  measurementId: "G-V79WXF88B5"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let me, currentChatId, friendUid, recorder, chunks = [];

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            me = user;
            const uRef = doc(db, "users", user.uid);
            const snap = await getDoc(uRef);
            let handle = snap.exists() ? snap.data().handle : "@user_" + user.uid.substring(0,4);
            if(!snap.exists()) await setDoc(uRef, { handle, uid: user.uid });
            document.getElementById('myHandle').innerText = handle;
            
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (Ø§Ù„Ø±ÙØ¶ ÙˆØ§Ù„Ù‚Ø¨ÙˆÙ„)
            onSnapshot(doc(db, "calls", me.uid), (s) => {
                if(!s.exists()) { document.getElementById('callOverlay').style.display = 'none'; return; }
                const data = s.data();
                if(data.type === 'offer') showIncomingCall(data);
                if(data.type === 'answer') connectCall(data.answer);
            });

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
            onSnapshot(collection(db, "users", me.uid, "contacts"), (s) => {
                const list = document.getElementById('contactsList');
                list.innerHTML = "";
                s.forEach(d => {
                    const f = d.data();
                    const el = document.createElement('div');
                    el.style = "padding:15px; border-bottom:1px solid #eee; cursor:pointer;";
                    el.innerText = f.handle;
                    el.onclick = () => selectFriend(f);
                    list.appendChild(el);
                });
            });
        } else { signInAnonymously(auth); }
    });

    // --- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ© ---
    window.recordStart = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                await addDoc(collection(db, "chats", currentChatId, "messages"), {
                    content: reader.result, type: 'audio', sender: me.uid, time: serverTimestamp()
                });
            };
            chunks = [];
        };
        recorder.start();
        document.getElementById('micBtn').classList.add('recording-active');
    };
    window.recordStop = () => { recorder.stop(); document.getElementById('micBtn').classList.remove('recording-active'); };

    // --- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ± ---
    window.sendImage = (input) => {
        const file = input.files[0];
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            await addDoc(collection(db, "chats", currentChatId, "messages"), {
                content: reader.result, type: 'image', sender: me.uid, time: serverTimestamp()
            });
        };
    };

    // --- Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¶) ---
    window.rejectOrEndCall = async () => {
        await deleteDoc(doc(db, "calls", me.uid));
        if(friendUid) await deleteDoc(doc(db, "calls", friendUid));
        location.reload(); 
    };

    // Ø¨Ù‚ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    window.addFriend = async () => {
        const handle = document.getElementById('targetUser').value;
        const q = query(collection(db, "users"), where("handle", "==", handle));
        const snap = await getDocs(q);
        if(!snap.empty) {
            const f = snap.docs[0].data();
            await setDoc(doc(db, "users", me.uid, "contacts", f.uid), f);
            const myInfo = (await getDoc(doc(db, "users", me.uid))).data();
            await setDoc(doc(db, "users", f.uid, "contacts", me.uid), myInfo);
        }
    };

    window.sendTextMsg = async () => {
        const txt = document.getElementById('msgText').value;
        if(!currentChatId || !txt) return;
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            content: txt, type: 'text', sender: me.uid, time: serverTimestamp()
        });
        document.getElementById('msgText').value = "";
    };

    async function selectFriend(f) {
        friendUid = f.uid;
        currentChatId = me.uid < f.uid ? `${me.uid}_${f.uid}` : `${f.uid}_${me.uid}`;
        document.getElementById('activeFriendTitle').innerText = f.handle;
        document.getElementById('callBtn').style.display = 'block';
        loadMessages();
    }

    function loadMessages() {
        const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("time", "asc"));
        onSnapshot(q, (snaps) => {
            const box = document.getElementById('messageBox');
            box.innerHTML = "";
            snaps.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = `msg ${m.sender === me.uid ? 'sent' : 'received'}`;
                if(m.type === 'text') div.innerText = m.content;
                else if(m.type === 'image') div.innerHTML = `<img src="${m.content}">`;
                else div.innerHTML = `<audio src="${m.content}" controls></audio>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
</script>
</body>
</html>
