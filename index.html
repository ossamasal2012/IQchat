<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>IQMessage VIP - Ù…ÙƒØ§Ù„Ù…Ø§Øª ÙˆØ±Ø³Ø§Ø¦Ù„</title>
    <style>
        :root { --primary: #0084ff; --success: #28a745; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #e5ddd5; }
        
        /* Sidebar */
        .sidebar { width: 300px; background: white; border-left: 1px solid #ccc; display: flex; flex-direction: column; }
        .user-card { padding: 15px; background: var(--primary); color: white; text-align: center; }
        
        /* Main Chat */
        .main { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 10px 20px; background: #f0f0f0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        /* Bubbles */
        .msg { padding: 10px; border-radius: 12px; max-width: 70%; font-size: 14px; position: relative; }
        .sent { align-self: flex-end; background: #dcf8c6; }
        .received { align-self: flex-start; background: white; }
        
        /* Call UI */
        #callOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); 
                        display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 1000; }
        
        /* Controls */
        .input-bar { padding: 15px; background: #f0f0f0; display: flex; gap: 10px; }
        .btn { border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; color: white; font-weight: bold; }
        .btn-call { background: var(--success); }
        .btn-send { background: var(--primary); }
        .btn-mic { background: var(--danger); }
        input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; outline: none; }
    </style>
</head>
<body>

    <div id="callOverlay">
        <h2 id="callStatus">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„...</h2>
        <audio id="remoteAudio" autoplay></audio>
        <button class="btn" style="background:var(--danger); margin-top: 20px;" onclick="endCall()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©</button>
    </div>

    <div class="sidebar">
        <div class="user-card">
            <div id="myHandle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <div style="padding: 15px;">
            <input type="text" id="friendID" placeholder="Ø£Ø¯Ø®Ù„ @user Ù„Ù„ØµØ¯ÙŠÙ‚">
            <button class="btn btn-send" style="width: 100%; margin-top: 10px;" onclick="startChat()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>
        <div id="friendsList"></div>
    </div>

    <div class="main">
        <div class="chat-header">
            <strong id="chatTitle">Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚Ø§Ù‹</strong>
            <button class="btn btn-call" id="callBtn" style="display: none;" onclick="initiateCall()">ğŸ“ Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©</button>
        </div>
        <div class="messages" id="messageBox"></div>
        <div class="input-bar">
            <input type="text" id="textInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
            <button class="btn btn-mic" onmousedown="startVoice()" onmouseup="stopVoice()">ğŸ¤</button>
            <button class="btn btn-send" onclick="sendText()">â¤</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3wLBeOqmW1LZBLR2icOwDdbUBD8EstYQ",
  authDomain: "iqmassege.firebaseapp.com",
  projectId: "iqmassege",
  storageBucket: "iqmassege.firebasestorage.app",
  messagingSenderId: "430582759156",
  appId: "1:430582759156:web:b0fcd429433607e16ae8a1",
  measurementId: "G-V79WXF88B5"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let me, currentChatId, friendUid;
    let localStream, peerConnection;
    const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            me = user;
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            let handle = snap.exists() ? snap.data().handle : "@user_" + user.uid.substring(0,4);
            if(!snap.exists()) await setDoc(userRef, { handle, uid: user.uid });
            document.getElementById('myHandle').innerText = "Ø£Ù†Øª: " + handle;
            listenForCalls(); // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
        } else { signInAnonymously(auth); }
    });

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ØµÙˆØªÙŠØ© (WebRTC) ---
    window.initiateCall = async () => {
        document.getElementById('callOverlay').style.display = 'flex';
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        peerConnection = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = (event) => {
            document.getElementById('remoteAudio').srcObject = event.streams[0];
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¹Ø¨Ø± Firestore
        await setDoc(doc(db, "calls", friendUid), {
            offer: { type: offer.type, sdp: offer.sdp },
            callerHandle: document.getElementById('myHandle').innerText,
            callerUid: me.uid
        });

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø¯ (Answer)
        onSnapshot(doc(db, "calls", friendUid), async (snap) => {
            const data = snap.data();
            if (data?.answer && !peerConnection.currentRemoteDescription) {
                const answerDescription = new RTCSessionDescription(data.answer);
                await peerConnection.setRemoteDescription(answerDescription);
                document.getElementById('callStatus').innerText = "ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø©...";
            }
        });
    };

    function listenForCalls() {
        onSnapshot(doc(db, "calls", me.uid), async (snap) => {
            const data = snap.data();
            if (data && data.offer && !peerConnection) {
                if (confirm(`Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø±Ø¯Ø© Ù…Ù† ${data.callerHandle}.. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø±Ø¯ØŸ`)) {
                    document.getElementById('callOverlay').style.display = 'flex';
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    peerConnection = new RTCPeerConnection(servers);
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                    peerConnection.ontrack = (event) => {
                        document.getElementById('remoteAudio').srcObject = event.streams[0];
                    };

                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    await setDoc(doc(db, "calls", me.uid), { answer: { type: answer.type, sdp: answer.sdp } }, { merge: true });
                    document.getElementById('callStatus').innerText = "ÙÙŠ Ù…ÙƒØ§Ù„Ù…Ø©...";
                }
            }
        });
    }

    window.endCall = async () => {
        location.reload(); // Ø£Ø³Ø±Ø¹ Ø·Ø±ÙŠÙ‚Ø© Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©
    };

    // --- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© ÙˆØ§Ù„ØµÙˆØªÙŠØ© (Ù†ÙØ³ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø­Ø³Ù†) ---
    window.startChat = async () => {
        const handle = document.getElementById('friendID').value;
        const q = query(collection(db, "users"), where("handle", "==", handle));
        const snap = await getDocs(q);
        if(!snap.empty) {
            const f = snap.docs[0].data();
            friendUid = f.uid;
            currentChatId = me.uid < f.uid ? `${me.uid}_${f.uid}` : `${f.uid}_${me.uid}`;
            document.getElementById('chatTitle').innerText = "Ø¯Ø±Ø¯Ø´Ø©: " + handle;
            document.getElementById('callBtn').style.display = 'block';
            loadMessages();
        }
    };

    window.sendText = async () => {
        const text = document.getElementById('textInput').value;
        if(!currentChatId || !text) return;
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            content: text, type: 'text', sender: me.uid, time: serverTimestamp()
        });
        document.getElementById('textInput').value = "";
    };

    function loadMessages() {
        const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("time", "asc"));
        onSnapshot(q, (snaps) => {
            const box = document.getElementById('messageBox');
            box.innerHTML = "";
            snaps.forEach(d => {
                const m = d.data();
                const div = document.createElement('div');
                div.className = `msg ${m.sender === me.uid ? 'sent' : 'received'}`;
                div.innerText = m.content;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }
</script>
</body>
</html>
