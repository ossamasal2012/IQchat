<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQMessage Ultra Max V2</title>
    <style>
        :root { --primary: #0084ff; --success: #28a745; --danger: #dc3545; --dark: #232d36; --light: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Layout */
        .app-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 300px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; position: relative; }

        /* Bubbles */
        .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 75%; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 15px; }
        .sent { align-self: flex-end; background: #dcf8c6; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: white; border-bottom-left-radius: 2px; }
        
        /* Voice Message Styling */
        .voice-msg-container { display: flex; align-items: center; gap: 10px; min-width: 160px; padding: 5px 0; }
        .play-btn { width: 35px; height: 35px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .voice-wave { flex: 1; height: 3px; background: rgba(0,0,0,0.1); position: relative; border-radius: 2px; }

        /* Call UI */
        #callOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, #2c3e50, #000); display:none; flex-direction:column; align-items:center; justify-content:center; color:white; z-index:9999; }
        
        /* Responsive */
        @media (max-width: 768px) { .sidebar { display: none; } }
    </style>
</head>
<body>

    <div id="callOverlay">
        <div style="font-size: 80px; margin-bottom: 20px;">ğŸ‘¤</div>
        <h2 id="callInfo">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„...</h2>
        <audio id="remoteAudio" autoplay></audio>
        <div style="display: flex; gap: 30px; margin-top: 20px;">
            <button id="acceptCall" onclick="acceptIncomingCall()" style="width:60px; height:60px; border-radius:50%; background:var(--success); color:white; border:none; display:none; font-size:24px; cursor:pointer;">ğŸ“</button>
            <button onclick="endCall()" style="width:60px; height:60px; border-radius:50%; background:var(--danger); color:white; border:none; font-size:24px; cursor:pointer;">ğŸ“µ</button>
        </div>
    </div>

    <div class="main-chat">
        <div style="padding:10px; background:#eee; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ddd;">
            <b id="activeFriendTitle">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©</b>
            <button id="callBtn" onclick="initiateVoiceCall()" style="display:none; border:none; background:none; font-size:24px; cursor:pointer;">ğŸ“</button>
        </div>
        
        <div class="messages" id="messageBox"></div>

        <div style="padding:10px; background:#f0f0f0; display:flex; gap:10px; align-items:center;">
            <input type="text" id="msgText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="flex:1; padding:12px; border-radius:25px; border:none; outline:none;">
            <button id="micBtn" onmousedown="startRecording()" onmouseup="stopRecording()" style="width:45px; height:45px; border-radius:50%; border:none; background:var(--danger); color:white; cursor:pointer;">ğŸ¤</button>
            <button onclick="sendTextMsg()" style="width:45px; height:45px; border-radius:50%; border:none; background:var(--primary); color:white; cursor:pointer;">â¤</button>
        </div>
    </div>

<script type="module">
    // (Ø¶Ø¹ Ù‡Ù†Ø§ Ø§Ø³ØªÙŠØ±Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆÙƒÙˆØ¯ Ø§Ù„Ù€ Config Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ)
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ---
    const firebaseConfig = {
        apiKey: "AIzaSyA3wLBeOqmW1LZBLR2icOwDdbUBD8EstYQ",
        authDomain: "iqmassege.firebaseapp.com",
        projectId: "iqmassege",
        storageBucket: "iqmassege.firebasestorage.app",
        messagingSenderId: "430582759156",
        appId: "1:430582759156:web:b0fcd429433607e16ae8a1",
        measurementId: "G-V79WXF88B5"
    };

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ... Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© (Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§ØªØŒ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ Ø¥Ù„Ø®)
</script>
    let localStream, peerConn, currentCallData;

    // --- ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ØµÙˆØªÙŠØ© ---
    window.initiateVoiceCall = async () => {
        if (!friendUid) return;
        document.getElementById('callOverlay').style.display = 'flex';
        document.getElementById('callInfo').innerText = "Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ " + document.getElementById('activeFriendTitle').innerText;

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            peerConn = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            
            localStream.getTracks().forEach(track => peerConn.addTrack(track, localStream));
            peerConn.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];

            const offer = await peerConn.createOffer();
            await peerConn.setLocalDescription(offer);

            await setDoc(doc(db, "calls", friendUid), {
                type: 'offer',
                offer: { sdp: offer.sdp, type: offer.type },
                callerName: me.handle,
                callerUid: me.uid
            });
        } catch (err) {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†!");
            endCall();
        }
    };

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
    function listenForCalls() {
        onSnapshot(doc(db, "calls", me.uid), async (s) => {
            if (!s.exists()) {
                document.getElementById('callOverlay').style.display = 'none';
                if(peerConn) peerConn.close();
                return;
            }
            const data = s.data();
            if (data.type === 'offer') {
                currentCallData = data;
                document.getElementById('callOverlay').style.display = 'flex';
                document.getElementById('callInfo').innerText = "Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ù† " + data.callerName;
                document.getElementById('acceptCall').style.display = 'block';
            }
            if (data.type === 'answer' && peerConn) {
                await peerConn.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
        });
    }

    window.acceptIncomingCall = async () => {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        peerConn = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        localStream.getTracks().forEach(track => peerConn.addTrack(track, localStream));
        peerConn.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];

        await peerConn.setRemoteDescription(new RTCSessionDescription(currentCallData.offer));
        const answer = await peerConn.createAnswer();
        await peerConn.setLocalDescription(answer);

        await updateDoc(doc(db, "calls", me.uid), {
            type: 'answer',
            answer: { sdp: answer.sdp, type: answer.type }
        });
        document.getElementById('acceptCall').style.display = 'none';
        document.getElementById('callInfo').innerText = "Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø§Ø±ÙŠØ©...";
    };

    window.endCall = async () => {
        await deleteDoc(doc(db, "calls", me.uid));
        location.reload(); 
    };

    // --- ØªØ­Ø³ÙŠÙ† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ© ÙˆÙˆÙ‚Øª 12 Ø³Ø§Ø¹Ø© ---
    function formatMessageTime(timestamp) {
        if (!timestamp) return "";
        return timestamp.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
    }

    function renderMessage(m) {
        const time = formatMessageTime(m.time);
        const isMe = m.sender === me.uid;
        
        let content = "";
        if (m.type === 'text') content = `<div>${m.content}</div>`;
        else if (m.type === 'audio') {
            content = `
                <div class="voice-msg-container">
                    <button class="play-btn" onclick="playAudio('${m.content}', this)">â–¶</button>
                    <div class="voice-wave"></div>
                    <span style="font-size:10px;">ØµÙˆØª</span>
                </div>`;
        }
        
        return `
            <div class="msg ${isMe ? 'sent' : 'received'}">
                ${content}
                <div style="font-size:9px; opacity:0.5; margin-top:4px; text-align:left;">${time}</div>
            </div>`;
    }

    window.playAudio = (src, btn) => {
        const audio = new Audio(src);
        audio.play();
        btn.innerText = "â¸";
        audio.onended = () => btn.innerText = "â–¶";
    };

    // (Ø£ÙƒÙ…Ù„ Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ loadMessages Ù„ÙŠØ¹Ù…Ù„ Ù…Ø¹ renderMessage)
</script>
</body>
</html>
