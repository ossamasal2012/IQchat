<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQMessage Ultra Max V2</title>
    <style>
        :root { --primary: #0084ff; --success: #28a745; --danger: #dc3545; --dark: #232d36; --light: #f0f2f5; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--light); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Layout */
        .app-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 300px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; position: relative; }

        /* Bubbles */
        .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 75%; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 15px; }
        .sent { align-self: flex-end; background: #dcf8c6; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: white; border-bottom-left-radius: 2px; }
        
        /* Voice Message Styling */
        .voice-msg-container { display: flex; align-items: center; gap: 10px; min-width: 160px; padding: 5px 0; }
        .play-btn { width: 35px; height: 35px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .voice-wave { flex: 1; height: 3px; background: rgba(0,0,0,0.2); position: relative; border-radius: 2px; }

        /* Call UI */
        #callOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, #2c3e50, #000); display:none; flex-direction:column; align-items:center; justify-content:center; color:white; z-index:9999; }
        
        /* Responsive */
        @media (max-width: 768px) { .sidebar { width: 100%; display: none; } .sidebar.active { display: flex; position: absolute; z-index: 10; height: 100%; } }

        input, button { font-family: inherit; }
    </style>
</head>
<body>

    <div id="callOverlay">
        <div style="font-size: 80px; margin-bottom: 20px;">ğŸ‘¤</div>
        <h2 id="callInfo">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„...</h2>
        <audio id="remoteAudio" autoplay></audio>
        <div style="display: flex; gap: 30px; margin-top: 20px;">
            <button id="acceptCall" onclick="acceptIncomingCall()" style="width:60px; height:60px; border-radius:50%; background:var(--success); color:white; border:none; display:none; font-size:24px; cursor:pointer;">ğŸ“</button>
            <button onclick="endCall()" style="width:60px; height:60px; border-radius:50%; background:var(--danger); color:white; border:none; font-size:24px; cursor:pointer;">ğŸ“µ</button>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div style="padding: 20px; background: var(--dark); color: white; text-align: center;">
                <div style="font-weight: bold;">IQMessage Pro</div>
                <small id="myHandleDisplay">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</small>
            </div>
            <div style="padding: 15px; border-bottom: 1px solid #eee;">
                <input type="text" id="targetInput" placeholder="Ø£Ø¶Ù @username Ø§Ù„ØµØ¯ÙŠÙ‚..." style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; box-sizing: border-box;">
                <button onclick="addFriend()" style="width:100%; margin-top:10px; padding:10px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©</button>
            </div>
            <div id="contactsList" style="flex:1; overflow-y:auto;"></div>
        </div>

        <div class="main-chat">
            <div style="padding:10px; background:#eee; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ddd;">
                <b id="activeFriendTitle">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©</b>
                <button id="callBtn" onclick="initiateVoiceCall()" style="display:none; border:none; background:none; font-size:24px; cursor:pointer;">ğŸ“</button>
            </div>
            
            <div class="messages" id="messageBox"></div>

            <div style="padding:10px; background:#f0f0f0; display:flex; gap:10px; align-items:center;">
                <input type="text" id="msgText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="flex:1; padding:12px; border-radius:25px; border:none; outline:none;">
                <button id="micBtn" onmousedown="startRecording()" onmouseup="stopRecording()" style="width:45px; height:45px; border-radius:50%; border:none; background:var(--danger); color:white; cursor:pointer;">ğŸ¤</button>
                <button onclick="sendTextMsg()" style="width:45px; height:45px; border-radius:50%; border:none; background:var(--primary); color:white; cursor:pointer;">â¤</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA3wLBeOqmW1LZBLR2icOwDdbUBD8EstYQ",
        authDomain: "iqmassege.firebaseapp.com",
        projectId: "iqmassege",
        storageBucket: "iqmassege.firebasestorage.app",
        messagingSenderId: "430582759156",
        appId: "1:430582759156:web:b0fcd429433607e16ae8a1",
        measurementId: "G-V79WXF88B5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let me = null;
    let friendUid = null;
    let currentChatId = null;
    let localStream, peerConn, currentCallData;
    let recorder, chunks = [];

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            me = user;
            const uRef = doc(db, "users", user.uid);
            const snap = await getDoc(uRef);
            let handle = snap.exists() ? snap.data().handle : "@user_" + user.uid.substring(0,4);
            if(!snap.exists()) {
                await setDoc(uRef, { handle: handle, uid: user.uid });
                me.handle = handle;
            } else {
                me.handle = snap.data().handle;
            }
            document.getElementById('myHandleDisplay').innerText = "Ù…Ø¹Ø±ÙÙƒ: " + me.handle;
            
            listenForCalls();
            listenForContacts();
        } else {
            signInAnonymously(auth);
        }
    });

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ---
    window.addFriend = async () => {
        const handle = document.getElementById('targetInput').value.trim();
        if(!handle) return;
        const q = query(collection(db, "users"), where("handle", "==", handle));
        const snap = await getDocs(q);
        if(!snap.empty) {
            const fData = snap.docs[0].data();
            await setDoc(doc(db, "users", me.uid, "contacts", fData.uid), fData);
            await setDoc(doc(db, "users", fData.uid, "contacts", me.uid), { handle: me.handle, uid: me.uid });
            document.getElementById('targetInput').value = "";
        } else {
            alert("Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
        }
    };

    function listenForContacts() {
        onSnapshot(collection(db, "users", me.uid, "contacts"), (snap) => {
            const list = document.getElementById('contactsList');
            list.innerHTML = "";
            snap.forEach(d => {
                const f = d.data();
                const div = document.createElement('div');
                div.style = "padding:15px; border-bottom:1px solid #eee; cursor:pointer;";
                div.innerText = f.handle;
                div.onclick = () => selectFriend(f);
                list.appendChild(div);
            });
        });
    }

    async function selectFriend(f) {
        friendUid = f.uid;
        currentChatId = me.uid < f.uid ? `${me.uid}_${f.uid}` : `${f.uid}_${me.uid}`;
        document.getElementById('activeFriendTitle').innerText = f.handle;
        document.getElementById('callBtn').style.display = 'block';
        loadMessages();
    }

    window.sendTextMsg = async () => {
        const txt = document.getElementById('msgText').value.trim();
        if(!currentChatId || !txt) return;
        await addDoc(collection(db, "chats", currentChatId, "messages"), {
            content: txt, type: 'text', sender: me.uid, time: serverTimestamp()
        });
        document.getElementById('msgText').value = "";
    };

    // --- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ© ---
    window.startRecording = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = async () => {
                    await addDoc(collection(db, "chats", currentChatId, "messages"), {
                        content: reader.result, type: 'audio', sender: me.uid, time: serverTimestamp()
                    });
                };
                chunks = [];
            };
            recorder.start();
            document.getElementById('micBtn').style.background = "orange";
        } catch (e) { alert("Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ø·Ù„ÙˆØ¨!"); }
    };

    window.stopRecording = () => {
        if(recorder) {
            recorder.stop();
            document.getElementById('micBtn').style.background = "var(--danger)";
        }
    };

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª ---
    window.initiateVoiceCall = async () => {
        document.getElementById('callOverlay').style.display = 'flex';
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            peerConn = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            localStream.getTracks().forEach(t => peerConn.addTrack(t, localStream));
            peerConn.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];

            const offer = await peerConn.createOffer();
            await peerConn.setLocalDescription(offer);
            await setDoc(doc(db, "calls", friendUid), {
                type: 'offer', offer: { sdp: offer.sdp, type: offer.type },
                callerName: me.handle, callerUid: me.uid
            });
        } catch (e) { endCall(); }
    };

    function listenForCalls() {
        onSnapshot(doc(db, "calls", me.uid), async (s) => {
            if (!s.exists()) {
                document.getElementById('callOverlay').style.display = 'none';
                return;
            }
            const data = s.data();
            if (data.type === 'offer') {
                currentCallData = data;
                document.getElementById('callOverlay').style.display = 'flex';
                document.getElementById('callInfo').innerText = "Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ù† " + data.callerName;
                document.getElementById('acceptCall').style.display = 'block';
            }
            if (data.type === 'answer' && peerConn) {
                await peerConn.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
        });
    }

    window.acceptIncomingCall = async () => {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        peerConn = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        localStream.getTracks().forEach(t => peerConn.addTrack(t, localStream));
        peerConn.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];
        await peerConn.setRemoteDescription(new RTCSessionDescription(currentCallData.offer));
        const answer = await peerConn.createAnswer();
        await peerConn.setLocalDescription(answer);
        await updateDoc(doc(db, "calls", me.uid), {
            type: 'answer', answer: { sdp: answer.sdp, type: answer.type }
        });
        document.getElementById('acceptCall').style.display = 'none';
    };

    window.endCall = async () => {
        if(friendUid) await deleteDoc(doc(db, "calls", friendUid));
        await deleteDoc(doc(db, "calls", me.uid));
        location.reload();
    };

    // --- Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ÙˆÙ‚Øª ---
    function loadMessages() {
        const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("time", "asc"));
        onSnapshot(q, (snaps) => {
            const box = document.getElementById('messageBox');
            box.innerHTML = "";
            snaps.forEach(d => {
                const m = d.data();
                box.innerHTML += renderMessage(m);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    function renderMessage(m) {
        const date = m.time ? m.time.toDate() : new Date();
        const timeStr = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
        const isMe = m.sender === me.uid;
        let content = m.type === 'text' ? `<div>${m.content}</div>` : 
            `<div class="voice-msg-container">
                <button class="play-btn" onclick="playAudio('${m.content}', this)">â–¶</button>
                <div class="voice-wave"></div>
            </div>`;
        return `<div class="msg ${isMe ? 'sent' : 'received'}">${content}<div style="font-size:9px; opacity:0.5; margin-top:4px;">${timeStr}</div></div>`;
    }

    window.playAudio = (src, btn) => {
        const audio = new Audio(src);
        audio.play();
        btn.innerText = "â¸";
        audio.onended = () => btn.innerText = "â–¶";
    };
</script>
</body>
</html>
